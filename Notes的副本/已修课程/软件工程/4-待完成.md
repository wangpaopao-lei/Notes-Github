## 生成账单

```Python
@app.get('/api/user/query_order_detail')
@authorized()
async def query_order_detail(request):
    user = session.query(User).filter(
        User.username == get_username(request)).first()
    # TODO(2): 处理，获取该用户所有充电详单  √
    order_list = []
    # 读取数据库
    for record in session.query(ChargeRecord).filter(ChargeRecord.user_id == user.id):
        order_list.append({
            "order_id": record.order_id,
            "create_time": record.create_time,
            "charged_amount": record.charged_amount,
            "charged_time": record.charged_time,
            "begin_time": record.begin_time,
            "end_time": record.end_time,
            "charging_cost": record.charging_cost,
            "service_cost": record.service_cost,
            "total_cost": record.total_cost,
            "pile_id": record.pile_id
        })
    success = True
    error_msg = ""

    if success:
        return json({
            "code": 0,
            "message": "Success",
            "data": order_list
        })
    else:
        return json({
            "code": -1,
            "message": error_msg
        })
```



API：/api/user/charge_bill

两套实现方案：

1. 查询详单数据库的信息，在后端进行汇总计算后输出（简单）
2. 新建一个账单数据库，以车辆id为主键（较复杂）

问题：

1. 账单的期望展示效果，需要非常详细
2. 账单 id 的生成方式（能否通过详单直接生成）



```Python
@app.get('/api/user/charge_bill')
@authorized()
async def query_order_detail(request):
    user = session.query(User).filter(
        User.username == get_username(request)).first()
    # TODO(3): 生成该用户账单
	
 	 # 初始化结果
    order_id=""
    create_time=""
    charged_amount=0
    charged_time=0
    begin_time=""
    end_time=""
    charging_cost=0
    service_cost=0
    total_cost=0
    pile_id=[]
    # 读取数据库
    for record in session.query(ChargeRecord).filter(ChargeRecord.user_id == user.id):
        # 计算过程
        
        crea
    bill={
            "order_id": record.order_id,
            "create_time": record.create_time,
            "charged_amount": record.charged_amount,
            "charged_time": record.charged_time,
            "begin_time": record.begin_time,
            "end_time": record.end_time,
            "charging_cost": record.charging_cost,
            "service_cost": record.service_cost,
            "total_cost": record.total_cost,
            "pile_id": record.pile_id
        }
    success = True
    error_msg = ""

    if success:
        return json({
            "code": 0,
            "message": "Success",
            "data": bill
        })
    else:
        return json({
            "code": -1,
            "message": error_msg
        })
```

![image-20230615190945947](https://wangleidetuchuang.oss-cn-beijing.aliyuncs.com/img/image-20230615190945947.png)

详单 id 为年月日+充电请求 id