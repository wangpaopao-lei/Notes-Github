## contents

[toc]



# 向量处理机

![shadow-image-20230415151120028](https://wangleidetuchuang.oss-cn-beijing.aliyuncs.com/img/image-20230415151120028.png)





## 向量的处理方式

数据相关次数，功能切换次数

### 横向（水平）处理

![shadow-image-20230415160143224](https://wangleidetuchuang.oss-cn-beijing.aliyuncs.com/img/image-20230415160143224.png)

- 数据相关：N 次
- 功能切换：2N 次
- 不适用于向量处理机并行处理

### 纵向（垂直）处理

![shadow-image-20230415160236302](https://wangleidetuchuang.oss-cn-beijing.aliyuncs.com/img/image-20230415160236302.png)

- 数据相关：1 次
- 功能切换：1 次
- 适用于向量处理机



### 纵横（分组）处理

![shadow-image-20230415160308837](https://wangleidetuchuang.oss-cn-beijing.aliyuncs.com/img/image-20230415160308837.png)

- 数据相关：S+1 次
- 功能切换：2S+1 次
- 适用于向量处理机，**对向量长度 N 的大小不限制**

## 向量处理机结构

### 存储器-存储器结构

*适用于纵向处理方式*

![shadow-image-20230415161041772](https://wangleidetuchuang.oss-cn-beijing.aliyuncs.com/img/image-20230415161041772.png)

- 原向量和目的向量都存放在存储器中，运算的中间结果需要送回存储器
- 要充分发挥这种流水线的效率，存储器要不断提供源操作数，并不断从运算部件接收结果——对存储器的带宽要求非常高
- ==解决方法==：采用多体交叉并行存储器和缓冲器技术



### 寄存器-寄存器结构

*适用于分组处理方式*

分组处理中，向量长度 N 没有限制，但是组的长度 n 是固定不变的

![shadow-image-20230415162354952](https://wangleidetuchuang.oss-cn-beijing.aliyuncs.com/img/image-20230415162354952.png)

#### CRAY-1 结构

1. 向量寄存组 V
   - 由 512 个寄存器组成，分成 8 块每组
   - 每一个块称为一个向量寄存器
   - 每个向量寄存器可以每拍提供一个数据元素，或从功能部件接受一个结果元素
2. 标量寄存器 S 和快速暂存器 T
   - 标量寄存器有 8 个
   - 快速暂存器 T用于在标量暂存器和存储器之间提供缓冲
3. 向量屏蔽器 VM
   - 64 位，每位对应向量寄存器的一个单元
   - 作用：对于向量的归并、压缩、还原、测试等操作

#### CRAY-1 显著特点

- 每个向量寄存器 Vi 都有连接到 6 个向量功能部件的单独总线
- 每个向量功能部件都有把运算结果送回向量寄存器的总线
- 只要不出现 Vi 冲突和功能部件冲突

## 提高向量处理机性能常用技术

### 设置多个功能部件

设置多个独立功能部件，使它们并行工作，并各自按流水方式工作

### 链接技术

#### 两条向量指令占用功能流水线和向量寄存器的四种情况

1. 指令不相关
2. 功能部件相关
3. 源寄存器冲突
4. 结果寄存器冲突

==当前一条指令的结果寄存器是后一条指令的源寄存器、且不存在任何其他冲突时，就可以采用链接技术提高性能==

<img src="https://wangleidetuchuang.oss-cn-beijing.aliyuncs.com/img/image-20230415164051367.png" alt="shadow-image-20230415164051367" style="zoom:50%;" />

具有**先写后读相关**的两条指令，在不出现功能部件冲突和原向量冲突的情况下，可以把功能部件链接起来进行流水处理。

#### 要求

1. 只有前一条指令的第一个结果元素送入结果向量寄存器的那一个时钟周期才可以进行链接
2. 当一条向量指令的两个源操作数分别是两条先行指令的结果寄存器时，要求先行的两条指令产生运算结果的时间必须相等
3. 要进行链接执行的向量指令的向量长度必须相等，否则无法链接

### 分段开采技术

*如果向量长度大于向量寄存器长度*

把向量分成长度固定的段，然后循环分段处理，每次循环只处理一个向量段。

*由硬件和软件控制完成，对程序猿透明*

### 采用多处理机系统



## 向量处理机性能评价

### 向量指令的处理时间$T_{vp}$

#### *执行一条长度为 n 的向量指令所需时间为*

$$
T_{vp}=T_s+T_e+(n-1)T_c
$$

- $T_s$：向量处理部件流水线建立的时间
- $T_e$：向量流水线的通过时间（第一队向量元素通过流水线并产生第一个结果所花的时间
- $T_C$：流水线的时钟周期

*换成时钟周期数*
$$
T_{vp}=[s+e+(n-1)T_C]
$$
*不考虑$T_s$，并令$T_{start}=e-1$*
$$
T_{vp}=(T_{start}+n)T_c
$$


- $T_{start}$：从一条向量指令执行开始到还差一个时钟周期就产生第一个结果所需的时钟周期数，可以称之为该向量指令的==启动时间==，此后，便是每个时钟周期流出一个结果，共有 n 个结果

#### *一组向量指令的处理时间*

主要取决于三个因素：

1. 向量的长度
2. 向量操作之间是否存在流水功能部件的使用冲突
3. 数据的相关性

##### 编队

- 把能在同一个时钟周期内以前开始执行的几条向量指令称为一个==编队==

- 编队后，这个向量指令序列总的执行时间为各编队的执行时间的和
- 编队的执行时间（启动时间）是编队中指令的最大执行时间（启动时间）

*总执行时间*
$$
T_{all}=\sum^m_{i=1} T_{vp}^{(i)}=\sum^m_{i=1}(T_{start}^{(i)}+n)T_c=(T_{start}+mn)T_c
$$
 *表示成时钟周期数*
$$
T_{all}=T_{start}+mn
$$


#### *分段开采时一组向量指令的总执时间*

*引入额外的处理操作*
$$
n/MVL=p
$$

$$
n\%MVL=q
$$

 这些操作引入的额外时间为$T_{loop}$

*对于最后一次循环*
$$
T_{last}=T_{start}+T_{loop}+m*q
$$
*其他每一次循环*
$$
T_{step}=T_{start}+T_{loop}+m*MVL
$$
*总执行时间可以写成*
$$
T_{all}=\lceil\frac{n}{MVL}\rceil *(T_{Start}+T_{loop})+mn
$$

###  最大性能$R_\infty$和半性能向量长度$n_{1/2}$

#### 峰值性能$R_\infty$

*表示当向量长度无穷大时，向量处理机的最高性能*
$$
R_\infty=\lim_{n\rightarrow\infty}\frac{向量指令序列中浮点运算次数*时钟频率}{向量指令序列执行所需的时钟周期数}
$$

#### 半性能向量长度$n_{1/2}$

*向量处理机性能为其最大性能一半时所需的向量长度*

<img src="https://wangleidetuchuang.oss-cn-beijing.aliyuncs.com/img/image-20230415180442654.png" alt="shadow-image-20230415180442654" style="zoom:50%;" />

#### 向量长度临界值$n_v$

*对某一计算任务而言，向量方式的处理速度优于标量串行方式处理速度时的最小向量长度*





## 实例



