# SCS

## 摘要

**背景**：空间转录组学有望极大地提高我们对组织组织和细胞间相互作用的理解。虽然当前大多数空间转录组学平台仅提供多细胞分辨率，每个点有 10-15 个细胞，但最新技术提供了更密集的点放置，从而实现了亚细胞分辨率。

**挑战/任务**：这些新方法的一个关键挑战是细胞分割和细胞点的分配。

**传统方法的问题**：传统的基于图像的分割方法是有限的，并且没有充分利用空间转录组学描述的信息。

**方法**：在这里，我们介绍 SCS，它将成像数据与测序数据相结合，以提高细胞分割的准确性。 SCS 使用 transformer 自适应地学习每个点相对于其细胞中心的位置，从而将点分配给细胞。 

**实验**：SCS 在两种新的亚细胞空间转录组学技术上进行了测试，其性能优于传统的基于图像的分割方法。 SCS 实现了更高的准确性，识别了更多的细胞，并提供了更真实的细胞大小估计。使用 SCS 斑点分配对 RNA 进行亚细胞分析可提供有关 RNA 定位的信息，并进一步支持分割结果。

## 文献综述

最近，针对空间蛋白质组学 [6] 或基于原位荧光杂交 (FISH) 的空间转录组学数据 [7, 8] 开发了新的分割方法。例如，Baysor [7] 通过使用转录物组成的高斯分布将每个细胞建模为椭球体，将观察到的分子空间聚类到基于 FISH 的数据的细胞。然而，此类数据中检测到的分子并不局限于预定义的点位置，这使得细胞形状建模变得更加容易。此外，大量的基因分析和每个点捕获的表达的稀疏性使得这些方法不适合基于测序的技术。迄今为止开发的大多数标准细胞分割方法依赖于细胞核或膜应变来识别细胞边界[9,10,11,12,13]。这些方法虽然成功，但没有充分利用空间转录组数据提供的信息，导致结果不太准确。此外，其中大多数[10,11,12,13]需要手动注释来进行模型训练，而在分析新组织时通常不容易获得足够数量的注释。

## 实验





## 数据







1. 预处理： 代码的预处理部分涉及调用`src.preprocessing`模块中的`preprocess`函数。此函数负责为训练转换器模型准备数据。预处理根据`patch_size`是否为零来采取不同的方式。如果`patch_size`为零，则整个部分将进行预处理。否则，将部分划分为较小的补丁，并逐个补丁进行预处理。预处理包括对齐染色图像和测序点，如果`prealigned`为`False`并且指定了对齐方法，则会进行对齐。
2. 训练Transformer模型： 在预处理完成后，调用`src.transformer`模块中的`train`函数来训练Transformer模型。Transformer模型可能使用深度学习技术进行细胞分割，训练使用了前一步准备的数据。如果`patch_size`为零，则整个部分用于训练；否则，使用补丁进行训练。
3. 后处理： 最后，通过调用`src.postprocessing`模块中的`postprocess`函数来执行后处理步骤。此函数用于从Transformer模型获得的细胞分割结果进行细化，并生成最终的细胞分割。如果`patch_size`大于零，则分别对每个补丁应用后处理步骤。

## 预处理


预处理函数`preprocess`是对输入的数据进行预处理和准备，以便后续用于神经网络的训练和细胞分割。下面逐步解释该函数的主要步骤：

1. 读取数据： 函数首先根据`prealigned`参数的值来读取输入数据。如果`prealigned`为`True`，则调用`st.io.read_bgi_agg`函数从TSV文件(`bin_file`)和TIFF图像文件(`image_file`)读取数据。否则，以未预对齐的方式读取数据。
2. 对图像进行对齐（可选）： 如果指定了对齐方法(`align`)，函数将调用`st.cs.refine_alignment`函数，将stain图层（`stain`）与其他层次的数据进行对齐，从而校准染色图像的位置。
3. 保存对齐前后的图像： 函数通过matplotlib将对齐前后的图像绘制出来，并保存为图片文件。
4. 细胞核分割： 函数调用`st.cs.mask_nuclei_from_stain`函数来从染色图像中分割细胞核。`otsu_classes`参数用于指定Otsu算法的类别数量，`otsu_index`参数用于选择Otsu算法计算阈值的类别索引。
5. Watershed分割： 函数接着调用`st.cs.find_peaks_from_mask`函数来寻找染色图像中的细胞核峰值，并调用`st.cs.watershed`函数进行Watershed分割，从而得到每个细胞的区域标签。
6. 数据准备： 函数根据细胞核分割的结果，为神经网络的训练准备数据。它提取每个细胞核周围一定区域内的基因表达数据，构成训练样本。同时，将背景区域作为负样本加入训练数据中。这样可以在训练时，通过神经网络学习细胞核的特征，并将其与背景区分开。
7. 数据保存： 最后，函数将准备好的训练数据保存为numpy的压缩文件（.npz）格式，以便后续神经网络的训练使用。

总体而言，预处理函数`preprocess`负责读取输入数据，对齐图像，进行细胞核分割，提取细胞周围的基因表达数据，并准备用于神经网络训练的数据。这些数据将在细胞分割的神经网络模型中用于细胞识别和定位。



## transformer

定义一些实用函数：

- `dir_to_class`：将方向角转换为独热编码的类别标签。该函数似乎用于基于（x，y）坐标的角度来对类别标签进行编码。
- `mlp`：多层感知器（MLP）函数，创建具有GELU激活和dropout的密集层堆叠。
- `masked_categorical_cross_entropy`：自定义损失函数。它似乎计算分类交叉熵损失，但对样本权重进行了掩码操作。
- `PatchEncoder`：自定义层，将输入数据的补丁投影到低维空间并加入位置嵌入。



1. 首先，函数将图像数据（可能是图像块）作为输入，并使用`transformer_classifier`（之前创建的Transformer分类器）进行预测。预测的输出将包括每个像素点所属的细胞类别标签。
2. 在预测的类别标签中，相同类别的像素点将被组合成一个完整的细胞。这可能涉及到一些后处理步骤，例如根据邻近像素点的类别将相邻的像素合并在一起，形成一个连续的细胞。
3. 细胞的位置和边界信息将被提取出来，例如细胞的中心坐标、形状、边界轮廓等。
4. 最后，将提取的细胞信息保存到一个结果文件中，以供进一步的分析或可视化。

## 后处理









# 文献翻译

## Abstract

空间转录组学有望极大地提高我们对组织组织和细胞间相互作用的理解。虽然当前大多数空间转录组学平台仅提供多细胞分辨率，每个点有 10-15 个细胞，但最新技术提供了更密集的点放置，从而实现了亚细胞分辨率。这些新方法的一个关键挑战是细胞分割和细胞点的分配。传统的基于图像的分割方法是有限的，并且没有充分利用空间转录组学描述的信息。在这里，我们介绍 SCS，它将成像数据与测序数据相结合，以提高细胞分割的准确性。 SCS 使用变压器神经网络自适应地学习每个点相对于其细胞中心的位置，从而将点分配给细胞。 SCS 在两种新的亚细胞空间转录组学技术上进行了测试，其性能优于传统的基于图像的分割方法。 SCS 实现了更高的准确性，识别了更多的细胞，并提供了更真实的细胞大小估计。使用 SCS 斑点分配对 RNA 进行亚细胞分析可提供有关 RNA 定位的信息，并进一步支持分割结果。

## Introduction

空间转录组学提供有关样品中细胞的表达和位置的信息，从而能够分析细胞间信号传导和细胞类型组织 [1, 2]。空间转录组学使用一组以规则间隔放置在样本上的条形码点来分析基因的表达[3]。迄今为止，大多数平台（包括 Visium [3]）使用的点间距最大为 100 μm。在这种放置中，每个点根据组织捕获 10-20 个细胞的 RNA，这使得该技术很难实现单细胞水平的分析。最近，新的空间技术实现了更密集的点放置。例如，Stereo-seq [4] 和 Seq-scope [5] 的平均点距为 0.5 μm，每个细胞平均有超过 1000 个点。

虽然前景光明，但分析此类新数据的一个具有挑战性的步骤是细胞分割和点整合以向每个细胞分配表达谱。最近，针对空间蛋白质组学 [6] 或基于原位荧光杂交 (FISH) 的空间转录组学数据 [7, 8] 开发了新的分割方法。例如，Baysor [7] 通过使用转录物组成的高斯分布将每个细胞建模为椭球体，将观察到的分子空间聚类到基于 FISH 的数据的细胞。然而，此类数据中检测到的分子并不局限于预定义的点位置，这使得细胞形状建模变得更加容易。此外，大量的基因分析和每个点捕获的表达的稀疏性使得这些方法不适合基于测序的技术。迄今为止开发的大多数标准细胞分割方法依赖于细胞核或膜应变来识别细胞边界[9,10,11,12,13]。这些方法虽然成功，但没有充分利用空间转录组数据提供的信息，导致结果不太准确。此外，其中大多数[10,11,12,13]需要手动注释来进行模型训练，而在分析新组织时通常不容易获得足够数量的注释。

为了解决这些问题，我们开发了 SCS（亚细胞空间转录组学细胞分割），它结合了测序和染色数据来改善高分辨率空间转录组学中的细胞分割。 SCS 通过三个关键步骤执行分段（图 1）。它首先使用 Watershed 算法从染色图像中识别细胞核 [9]。其次，变压器模型推断每个点是细胞的一部分还是细胞外基质（背景）的一部分，及其相对位置 w.r.t.通过注意力机制自适应地聚合来自邻近点的高维但稀疏的基因表达信息。为了训练模型，我们使用已识别的核内的正样本点和从高度置信的背景区域采样的负样本点。最后，通过跟踪从斑点到细胞核中心的梯度流，对被确定为细胞一部分的斑点进行分组。有关完整详细信息，请参阅方法。

我们将 SCS 应用于两个不同的高分辨率空间转录组学平台：使用 Stereo-seq [4] 并进行核染色分析的小鼠大脑数据集，以及来自 Seq-scope [5] 并进行 H&E 染色的小鼠肝脏数据集。为了评估性能，我们将 SCS 与这些平台使用的 Watershed 细胞分割以及流行的基于深度学习的分割方法（包括 Cellpose [10]、DeepCell [11] 和 StarDist [12]）进行了比较。正如我们所展示的，与这些方法相比，我们的方法获得了更准确的分割、更多的单元格和更真实的单元格大小。此外，我们进一步使用 SCS 分析不同 RNA 的亚细胞定位，并表明我们的结果与先验知识一致，进一步验证了我们分割的准确性。

## Results

### Application of SCS to high-resolution spatial transcriptomics data

我们在使用两个不同平台生成的公共亚细胞分辨率原位数据集上测试了 SCS：使用 Stereo-seq [4] 进行分析的小鼠大脑数据集和使用 Seq-scope [5] 的小鼠肝脏数据集。

Stereo-seq 数据集在单个切片中捕获整个成年小鼠大脑切片（面积约为 5.3 mm⇥7.0 mm）。带条形码的斑点排列成网格，斑点之间的距离为 0.5 μm（考虑到平均细胞直径为 20 μm，意味着每个细胞大约有 1200 个斑点，扩展数据图 1）。该数据集总共分析了超过 42,000,000 个点中的 26,177 个基因，每个点平均有 3.3 个唯一分子标识符 (UMI) 计数（扩展数据图 2）。通过核酸染色对脑切片进行成像，从而可以使用基于图像的方法对细胞核进行分割。

Seq-scope 数据集包含来自小鼠肝脏的四个组织切片。每个部分捕获 3  围绕组织的 0.93 mm⇥0.80 mm 区域。条形码斑点的中心距与 Stereo-seq 数据的距离相似，平均为 0.5 μm。总共对 24,171 个基因进行了四个部分的分析，每个部分包含超过 570,000 个点（扩展数据图 3），平均每个点有 5.7 个 UMI 计数（扩展数据图 4）。 Seq-scope 协议不使用细胞核染色，而是使用苏木精和伊红 (H&E) 染色对组织进行成像。因此，可以使用成像数据分割整个细胞体。

### SCS provides accurate cell segmentation

我们首先将 SCS 应用于 Stereo-seq 数据。为了评估其性能，我们将 SCS 与 Watershed 细胞分割（补充说明 1）以及其他基于深度学习的流行分割方法（包括 Cellpose [10]、DeepCell [11] 和 StarDist [12]）进行了比较。使用深度学习方法的适当预训练模型进行评估（补充说明2）。由于细胞分割的基本事实不存在，我们使用了一种流行的方法来评估细胞分割方法 [6, 7]。在本次评估中，我们比较了两种方法（SCS 和另一种方法）一致的区域和不一致的区域的表达（图 2a）。具体来说，对于每个细胞核，我们使用每种方法的分割来识别细胞掩模。然后计算该核的两个细胞掩模之间的交集和差异区域。接下来，我们估计了交叉区域和每个差异区域之间表达谱的相关性。由于交叉区域通常由细胞核主导，所有方法都很容易检测到它（更容易染色），因此我们将其视为基本事实，并将非交叉区域与交叉区域进行比较。我们期望差异区域与相交区域的相关性越高，该方法的分割就越准确。

在 Stereo-seq 数据集上，SCS 分割的平均相关性比 Watershed 的平均相关性高 24%（0.61 vs. 0.49）（图 2b），并且比所有其他深度学习分割方法的平均相关性高至少 13%（0.60 vs. 0.49）。 DeepCell 的 0.53）。虽然基于细胞核染色图像的图像方法往往会低估细胞大小，但 SCS 能够准确捕获细胞的细胞质区域（图 3a）。因此，与其他分割方法相比，SCS 的分割细胞显示出更真实的细胞直径 [14]（图 2c，补充说明 4）。我们进一步观察到，由于某些细胞的染色信号强度低，因此基于图像的方法完全遗漏了一些细胞。然而，SCS 可以仅根据转录组数据识别此类细胞 4 。（“新颖的预测”，图3b，补充说明5）。另一方面，仅通过基于图像的方法识别但被 SCS 遗漏的细胞要少得多（补充图 1），导致 SCS 的细胞比所有其他方法至少多 1.5%（StarDist 的 56,187 个与 55,364 个，其中是第二高，图 2d)。基于表达谱的 SCS 分割细胞的 UMAP [15] 投影表明，这些新颖的预测与使用图像分割的细胞相匹配（图 3e），表明它们可能是真实的细胞。新细胞预测所覆盖区域的染色信号也支持这些新预测的准确性（补充图2）。

对于 Seq 范围数据，由于使用了 H&E 图像，差异不太明显。尽管如此，SCS 与 Watershed 的相关性较高，分别为 0.88 和 0.86，并且比所有其他基于深度学习的方法具有更高的相关性（图 2b）。与细胞核染色相比，所有方法在使用细胞染色图像时都实现了更高的相关性，正如预期的那样（尽管，正如我们所表明的，通过使用表达值，SCS 仍然可以改善这种类型的染色）。由于使用细胞染色图像，不同的方法显示相似的细胞大小。 SCS 分割导致细胞直径 (19.9 ± 6.4 μm) 略大于 Watershed (18.3 ± 9.4 μm) 和 StarDist (16.2 ± 7.6 μm)，但略小于 Cellpose (21.1 ± 4.8 μm) 和 DeepCell ( 20.1±6.0μm）（图2c和3c）。同样，SCS 确定的细胞大小与之前的发现一致 [16]。此外，我们观察到，当染色图像中两个细胞的边界不清楚时，基于图像的方法倾向于将它们合并，而 SCS 可以借助转录组数据对它们进行分割（图 3d），从而导致至少多出 2.3%使用 SCS 分割时的细胞（分水岭的 4,456 与 4,354）（图 2d）。 UMAP 投影显示，新颖的细胞预测与与基于图像的预测重叠的细胞混合，但主要对应于细胞簇的子集（图 3f）。通过细胞类型注释的进一步研究（补充说明6）表明，这些新的预测更有可能是非实质细胞（例如库珀细胞和单核细胞衍生细胞）而不是肝细胞（图3h，j）。已知此类细胞较小，因此更难使用 H&E 染色进行识别 [5]。在将 SCS 分割与其他方法进行比较时，我们也观察到类似的趋势（补充图 3a-c）。Stereo-seq 数据集的细胞类型分析证实了 SCS 可以帮助从细胞尺寸较小的细胞类型中恢复细胞的事实（图 3g、3i，补充图 4a）。这些结果适用于我们比较的所有方法（补充图 3d-f、4b-d）。通过 SCS 的新预测对细胞类型的位置进行空间分析表明，它们位于一致的区域 5 。与组织的相关组织学特征（补充图 5-6）。

尽管 SCS 是为基于高分辨率测序的平台而设计的，但基于原位荧光杂交 (FISH) 的空间转录组学技术也提供亚细胞分辨率并且高度多重化。因此，我们在使用最先进的基于 FISH 的平台 seqFISH+ [17] 和 MERFISH [18] 生成的两个数据集上测试了 SCS。为了处理基于 FISH 的数据，我们将检测到的 RNA 点转换为网格状点（补充说明 7、8）。在这里，除了基于图像的方法之外，我们还将 SCS 与专门为 FISH 数据设计的两种细胞分割方法 Baysor [7] 和 JSTA [8] 进行了比较（补充注释 9、10）。结果表明，SCS 在基于 FISH 的数据上优于所有基于图像的分割方法，并且在我们查看的四个数据集的大多数数据集上优于 Baysor 和 JSTA（补充图 7-9）。此外，对于 seqFISH+ 数据集，可以使用手动注释的细胞分割地面实况 [17]。因此，我们通过量化分割与真实情况的一致性（并集交集（IoU））来验证使用这些数据的不同方法的性能。 SCS 实现了比所有其他方法更高的 IoU（0.75）（Baysor 的 0.47，第二高）（补充图 7）。

最后，我们还使用Mesmer模型[13]（补充说明2）测试了DeepCell，并观察到使用Mesmer并没有改善DeepCell结果（补充图7-9）。

### SCS enables sub-cellular analysis of spatial transcriptomics

虽然传统的空间转录组学是研究细胞类型表达和相互作用的强大方法 [19, 20]，但高分辨率方法的使用为表征单个细胞内的分子异质性打开了大门。这对于研究 RNA 动力学和充分了解组织中的细胞变异性非常重要 [21]。因此，我们使用 SCS 来研究 RNA 在细胞内的分布情况。具体来说，我们将每个细胞分为两个区域，细胞核区域（使用染色图像数据识别）和细胞质区域（通过SCS识别的细胞掩模的其余部分，图4a）。使用 t 检验鉴定了 RNA 在两组区域之间差异定位的基因（图 4b-c）。有趣的是，在这两个数据集中，实验证明存在于细胞核或细胞质中的 RNA [22] 在我们识别的相应区域的 RNA 中显着富集（对于 Stereo-seq，P =4.0 ⇥ 10 50，P =6.4 ⇥ 10 4 用于 Seq-scope、Fisher 精确检验、单侧、扩展数据图 5）。例如，长的 non6 编码 RNA (lncRNA) 是一种核转录物，与染色质相互作用并调节多个基因的转录 [23]。 Neat1 基因的 lncRNA 是众所周知的核转录本，构成细胞核中细胞器的核心组成部分 [24]。在 SCS 分割中，两种 RNA 都被鉴定为不同地定位于细胞核（图 4b）。相反，基因 Rab3a 和基因 V amp2 均编码参与神经递质释放并与细胞质囊泡相关的蛋白质 [25, 26]。在 SCS 分割的细胞质区域中发现它们都具有高表达水平（图 4b）。

对于我们比较的其他分割方法，重复了这些实验。我们发现，对于所有其他方法，与 SCS 鉴定的 RNA 相比，我们获得的经实验验证的 RNA 较少（补充图 10）。这些结果表明SCS分割可以更好地帮助高分辨率空间转录组数据中的亚细胞分析，并部分解释了为什么我们的模型可以利用转录组数据获得更好的细胞分割。

## Discussion

空间转录组数据分析的关键步骤是细胞分割。当使用最新的亚细胞分析平台时尤其如此。对于此类数据，准确的细胞分割至关重要，因为识别细胞边界的错误会直接影响细胞中基因表达水平的定量，并进一步影响下游分析。现有的针对该数据的细胞分割方法仅依赖于染色图像，没有充分利用实验提供的信息，导致结果不太准确。

在本研究中，我们开发了一种细胞分割方法，结合染色信息和表达数据来细化细胞分割。==与以前的方法不同，我们的方法侧重于斑点而不是染色。对于每个点，该方法尝试确定它是否在细胞内，如果是，则确定是哪个细胞内。一旦确定了这样的分配，通过对属于同一细胞的所有点进行分组来自然地分割细胞。==为了实现点分配，SCS 首先聚合来自相邻点的信息，然后将点映射到低维潜在表示，以确定它们与细胞中心的相对位置。==为了训练监督模型，我们首先识别作为基本事实的核心区域，然后使用这些区域中的正样本点和从高度置信的背景区域采样的负样本点来训练变压器模型，然后将其应用于整个部分。==

将 SCS 应用到使用最新最先进的原位捕获平台生成的两个数据集，证明了我们方法的优势。与几种广泛使用的基于图像的分割方法相比，SCS 分割实现了更高的分割精度，检测更多的细胞，并产生更真实的细胞大小。对 RNA 空间分布的分析发现，许多 RNA 富集在不同的亚细胞区域，这些与实验证实的结果一致。这些发现进一步验证了 SCS 分割，并表明 SCS 促进高分辨率空间转录组学亚细胞分析的能力。

尽管 SCS 在我们测试的平台上运行良好，但还有许多方法可以进一步改进它。考虑到高密度点放置，可以进一步利用细胞形状信息来更好地获得细胞掩模。此外，还可以改进特征选择。在本研究中，我们使用 2,000 个可变基因作为 Transformer 模型的输入，尽管通过更复杂的特征选择方法可能会获得更好的结果。此外，如果发现 RNA 空间分布模式因数据集中的细胞类型而异 [27]，则可以引入细胞类型特定的注意层（基于表达谱），以允许模型学习不同的模式并更好地进行分割细胞。最后，虽然高维转录组学和成像数据的整合需要大量计算，但这样的运行时间对于分析这种复杂数据来说仍然是合理的（补充表1）。此外，还可以针对特定平台进一步优化运行时和内存。

由于大多数空间转录组数据通常无法获得基本事实，因此更细粒度的细胞类型分析可能为细胞分割质量提供更多证据。例如，可以恢复更合理的细胞类型分布或检测其他方法遗漏的稀有细胞类型的方法可能更强大。我们在论文中对此进行了一些初步分析（补充图 11），但可能需要更详细的分析来充分验证这一点。

SCS 用 Python 实现，可从以下网址下载：https://github.com/chenhcs/SCS。虽然亚细胞空间转录组学仍然非常新，但我们相信它的优势和提供空间分辨单细胞信息的能力将使其在未来非常受欢迎。我们希望 SCS 成为一种有用的预处理方法，以实现此类数据的所有下游分析。

## Figure captions

<img src="https://wangleidetuchuang.oss-cn-beijing.aliyuncs.com/img/image-20230810162723546.png" alt="shadow-image-20230810162723546" style="zoom: 33%;" />

**图 1：SCS 的工作流程**。

a，首先通过分割染色图像来识别细胞核（红色掩模）内的条形码 sopt（青色点）。接下来在这些点和一些背景点上训练变压器模型，以预测从每个点到其所属细胞中心的梯度方向（箭头）以及它是细胞一部分（黄色箭头）或部分的概率细胞外基质（紫色箭头）。然后将变压器模型应用于所有其他点。梯度流跟踪算法用于根据梯度预测对点进行分组来分割细胞。

b，Transformer 模型针对每个输入点预测 16 个预定义方向（^ d）从该点到其细胞中心的概率以及该点是细胞一部分的概率（^ y）。对于每个点（红点），变压器模型通过基于点表达式 (x) 和相对位置 (s) 自适应学习权重，聚合来自其 50 个最近相邻点（青色点）的信息。

c，一个transformer编码器层的结构，详细信息参见“方法”。

<img src="https://wangleidetuchuang.oss-cn-beijing.aliyuncs.com/img/image-20230810162740068.png" alt="shadow-image-20230810162740068" style="zoom:33%;" />

**图 2：SCS 的性能评估以及与其他方法的比较**。 a，用于评估性能和比较不同分割方法的基准。为每个单元计算两个分割之间的交叉区域和各自的差异（唯一）区域。如果其独特的细胞区域与交叉区域更好地相关，则据说分割具有更高的准确性。 b，使用相关性基准比较 SCS 和其他四种图像分割方法。用于评估的每个单元格都会为箱线图中呈现的相关性贡献一分。 SCS 在两个数据集上均取得了比其他方法更高的分割精度（Wilcoxon 符号秩检验，单向；对于 SCS 与 Watershed，Stereo-seq 上的 N =17,811 个细胞，Seq-scope 上的 N =2,757 个细胞；对于 SCS 与 Watershed Cellpose，Stereo-seq 上的 N = 13,310 个细胞，Seq 范围内的 N = 2,446 个细胞；对于 SCS 与 DeepCell，Stereo-seq 上的 N = 26,916 个细胞，Seq 范围上的 N = 3,513 个细胞，对于 SCS 与 StarDist , N = Stereo-seq 上的 6,370 个细胞，Seq-scope 上的 N = 2,635 个细胞。细胞过滤标准的补充注释 3）。 c，SCS与其他方法分割的细胞大小的比较。 SCS 获得的分段细胞比所有其他方法具有更大的细胞直径，并且在 Stereoseq 上具有显着差异（Kruskal-Wallis 测试；对于 Stereo-seq，N = 56,187，对于 SCS，N = 52,004，对于 Watershed，N = 50,020 对于 Cellpose，N对于 DeepCell，N = 55,260，对于 StarDist，N = 55,364；对于 Seq 范围，对于 SCS，N = 4,456，对于 Watershed，N = 4,354，对于 Cellpose，N = 2,527，对于 DeepCell，N = 4,157，对于 StarDist，N = 3,832）。红色虚线显示文献中预期的细胞直径。 d，通过两个数据集的分割方法识别的细胞数量。 b、c，箱线图显示中位数（每个箱中的水平线）、四分位数范围（箱）、1.5 四分位数（晶须）和剩余点个体。

<img src="https://wangleidetuchuang.oss-cn-beijing.aliyuncs.com/img/image-20230810162802843.png" alt="shadow-image-20230810162802843" style="zoom: 50%;" />

**图 3：细胞分割示例和低维空间中细胞的分布**。 a，SCS在细胞核染色中捕获细胞的细胞质区域，从而分割出更大尺寸的细胞。 b，Stereo-seq 数据集上的分割结果示例，其中 Watershed 由于染色信号强度低而错过了三个细胞，而 SCS 识别了它们（绿点）。 c，在 Seqscope 数据集上，两个分割显示相似的细胞大小，但细胞边界不一致。 d，Seq-scope 数据集上的分割示例，其中 Watershed 将两个细胞合并为一个细胞（粉红点），因为它们在图像中的边界不清晰，而 SCS 成功地对它们进行了分割（绿点）。 e，基于表达谱的 SCS 分段细胞在 Stereo-seq 数据集上的 UMAP 投影。新的预测（较暗的节点）与使用图像分割识别的细胞混合在一起。 f，SCS 分段细胞在 Seq 范围数据集上的 UMAP 投影。 g，Stereo-seq 数据集的细胞类型注释。 h，Seq范围数据集的细胞类型注释。 i，与 Watershed 相比，SCS 预测的新细胞数量与 Stereo-seq 数据集中不同细胞类型中 SCS 和 Watershed 通常识别的细胞数量。具有更新颖预测的细胞类型通常是细胞核尺寸较小的细胞类型，如补充图 4a 所示。 j，Seq 范围数据集的相同比较。 a-d，生成示例的实验独立重复三次，结果相似。比例尺：10 μm。

<img src="https://wangleidetuchuang.oss-cn-beijing.aliyuncs.com/img/image-20230810162822038.png" alt="shadow-image-20230810162822038" style="zoom:33%;" />

**图 4：使用 SCS 进行亚细胞分析**。 a，鉴定其RNA不同定位的基因。 b，火山图，显示 Stereo-seq 数据集的 SCS 分段细胞的细胞核和细胞质之间基因表达水平的定量变化。从每组中鉴定出 P 值 < 0.01 且倍数变化大于 1.3 的基因（t 检验，单方面，使用 Benjamini-hochberg 方法调整 P 值；N = 31,763 个细胞核区域，N = 37,940 个细胞质区域，具有至少 100 个基因的亚细胞区域用于此分析）。实验表明 RNA 存在于细胞核或细胞质中的基因会相应地着色。 c，Seq 范围数据集的火山图。从每组中鉴定出具有最小 P 值的前 100 个基因（显示 t 检验、单侧原始 P 值，以避免大多数 P 值被校正为相同值；N = 2,779 个核区域，N = 3,006 个细胞质区域，具有至少 100 个基因的区域用于此分析）。

## Method

1. spot 是什么
2. 基因组是什么

### Data Preprocessing

每个条形码 spot 中的基因计数是从 Stereo-seq [1] 和 Seq-scope [2] 的原始论文中收集的，并用于生成每个 spot 的基因表达谱向量。谱中的每个元素代表在该基因的 spot 中观察到的转录本的数量。

为了识别细胞核，首先将配对的染色图像和测序部分对齐以匹配图像像素和 spot 坐标。为此，==为测序部分创建了计数热图，其中热图中的每个元素包含一个 spot 中检测到的转录本的总数==。然后使用 Spateo (https://spateo-release.readthedocs.io) [1] 中实现的转换将染色图像与热图==对齐==。由于图像已预先对齐，因此 Seq-scope 数据集省略了此步骤。接下来，使用 Spateo 中实现的==分水岭算法从对齐的染色图像中分割细胞核，并获得每个细胞核的掩模==（补充说明 1）。

> 分水岭算法：
>
> 基本原理：
>
> 1. **拓扑表示**：首先，可以将图像看作是地形或拓扑地图，其中像素的亮度值代表其高度。
> 2. **洪水模拟**：在最低点（局部最小值）放水，水会开始上升，随着时间的推移，不同的洼地会被填满水。为了防止水从一个洼地流入另一个洼地，建起“堤坝”（watershed lines）来阻止它们。
> 3. **最终结果**：当所有的洼地都被填满后，建起的堤坝将形成物体的边界。
>
> 在图像处理中的步骤大致为：
>
> 1. 计算图像的梯度。这是为了确定“边界”在哪里。
> 2. 找到图像中的局部最小值，它们将成为填水的起始点。
> 3. 从这些局部最小值开始模拟“洪水填充”过程。当不同的“洪水”相遇时，创建一个分水岭。
> 4. 结束模拟后，得到的分水岭就是要分割的物体的边界。

### Transformer model for spot-level prediction

该模型的概述如图 1b 所示。该模型包含两个组件：编码器和分类器。==编码器将每个 spot 映射到隐藏表示 z==。考虑到通常为每个 spot 检测到的基因组非常稀疏，我们在生成点的隐藏表示时结合邻域基因表达信息，如下所示。对于每个点，我们使用其表达谱并将其与 50 个最近邻点的谱相结合，表示为 x =(x0,x1,...,x50)。**每个向量 xi 都有 N 个维度，代表研究中使用的每个 N 基因在该点检测到的转录本的数量**。最近邻是通过使用点坐标之间的欧氏距离来定义的。为了使模型能够使用不同邻居的相对位置，我们在编码器的输入中包含从中心点到每个邻居点的距离，表示为 s =(s0,s1,...,s50) ，其中 si 是包含两个轴上的距离的二维向量。给定一个 spot 的隐藏向量 z，分类器然后预测从该 spot 到其细胞中心的方向（用 ^ d 表示），以及它属于细胞一部分的概率 ^ y。

**编码器**：中心点和邻近点的表达谱 x 和距离向量 s 首先通过两个独立的全连接层投影到一组 D = 64 维向量 r，然后求和：

![image-20230810152519557](https://wangleidetuchuang.oss-cn-beijing.aliyuncs.com/img/image-20230810152519557.png)

其中 W1 2 RN⇥D 和 W2 2 R2⇥D 是两个全连接层层的权重矩阵。

我们使用了与原始 Transformer 论文 [3] 中提出的类似的网络架构。在此架构中，编码器由 L = 8 个相同层的堆栈组成。每层有两个块。第一个是自注意力块（SA）：

![image-20230810152552994](https://wangleidetuchuang.oss-cn-beijing.aliyuncs.com/img/image-20230810152552994.png)

其中张量 Uqkv 2 RD⇥3D 将每个点表示 ri 投影到三个 D 维向量：qi（查询）、ki（键）和 vi（值）。每个查询和所有键之间的点积（按 pD 缩放）通过 softmax 函数以获得注意力分数 A。注意力分数是相邻点的权重，然后乘以它们的值 v 和每个点获得 D 维度的加权表示。第二个块使用具有 128 和 64 个节点的双层全连接网络 (MLP) 进一步转换表示。 GELU [4]激活函数用于引入非线性。每层之后应用速率为 0.1 的 Dropout [5]。

层归一化（LN）[6]在每个块之前应用，残余连接[7]在每个块之后应用。总的来说，一个编码器层可以描述为：

![image-20230810152623705](https://wangleidetuchuang.oss-cn-beijing.aliyuncs.com/img/image-20230810152623705.png)

每个编码器层使用前一层的输出，rl 1，并生成下一层，rl。最后一个编码器层的中心点的表示，r0 L，被视为分类器的输入。

**分类器**：我们使用分类器来预测一个点从它到细胞中心的梯度方向，以及它是在细胞内还是细胞外。该分类器具有三个组件：（i）首先使用具有 1024 和 256 个节点的两层 MLP 来转换点表示 r0 L。 LN 在转换之前应用。然后，MLP 的输出用作两个全连接层的输入。 (ii) 一层连接到一个 softmax 函数，该函数输出到细胞中心的 16 个可能方向中每个方向的概率 ^ d。 (iii) 另一层生成标量输出 ^ y，它是该点的对象概率。使用多类交叉熵作为方向输出的损失函数：

![image-20230810152716404](https://wangleidetuchuang.oss-cn-beijing.aliyuncs.com/img/image-20230810152716404.png)

其中d是one-hot编码的方向标签，其中带1的位表示正确的方向。二元交叉熵损失用于对象概率：

![image-20230810152736066](https://wangleidetuchuang.oss-cn-beijing.aliyuncs.com/img/image-20230810152736066.png)

其中 y 是一个二进制标签，指示该点是否是细胞的一部分。考虑到训练数据中的所有 M 个点，总体损失函数为：

![image-20230810152753864](https://wangleidetuchuang.oss-cn-beijing.aliyuncs.com/img/image-20230810152753864.png)

方向损失被对象标签掩盖，因此背景点不会造成这种损失。

补充图 12 讨论了不同模型部件的选择。

### Training data preparation for the deep model

细胞核区域内的点和从高度置信的背景区域采样的点用于模型训练。核掩模内的所有点都被标记为 1 作为对象标签。对于方向标签，首先通过平均染色图像中分配给该核的点的 X 和 Y 坐标来计算每个核的中心。从核内每个点到核中心的方向 d 计算如下：

![image-20230810162010287](https://wangleidetuchuang.oss-cn-beijing.aliyuncs.com/img/image-20230810162010287.png)

其中X和Y是光点的两个轴坐标，Xc和Yc是核中心的坐标。 16个方向类别均匀地划分了一个完整的圆圈。另一方面，从背景中采样与核点相同数量的点，并将对象标签标记为 0。背景点必须满足以下两个标准：（i）相应像素的染色信号强度小于预定义的阈值。 (ii) 从该点到任何核中心的距离大于预定阈值。

### Cell boundry generation

点级预测根据已识别的细胞核的位置进行调整（补充说明 11），然后进行平滑（补充说明 12），然后用于将点分组为细胞。物体概率小于 0.1 的点被确定为背景。其余点的方向向量被视为梯度，并执行梯度流跟踪算法[8]来分割细胞。在该算法中，矢量流向汇，该汇对应于每个细胞的细胞核中心。从点 b =(X, Y ) 开始，使用以下方法选择流定向到的下一个点 b0：![image-20230810162050306](https://wangleidetuchuang.oss-cn-beijing.aliyuncs.com/img/image-20230810162050306.png)

其中 v(b) 是 b 处的梯度向量。当两个连续步骤之间的角度等于或大于⇡2时，梯度流跟踪过程停止，并且到达汇点。角度计算如下

![image-20230810162110857](https://wangleidetuchuang.oss-cn-beijing.aliyuncs.com/img/image-20230810162110857.png)

流向同一个水槽的一组斑点产生了水槽的吸引盆。如果两个汇之间的欧氏距离小于3.5个点，则将两个汇的吸引盆合并在一起以获得更大的吸引盆。至少具有一定数量点的吸引盆地被分割为一个单元（补充说明13）。

### Correlation benchmark

我们通过检查分割掩模的不同区域之间的转录相关性来评估不同方法的性能。具体来说，对于使用染色检测到的每个细胞核，通过选择与源细胞核重叠最大的细胞，使用我们的细胞分割来分配目标细胞 c。使用类似的方法根据比较方法的细胞分割来选择c0。计算考虑三个区域的所有基因的基因表达谱：(i) c 和 c0 之间的交集，表示为 xint，(ii) 由 c 但不包括 c0 覆盖的区域，表示为 xc，(iii) 和由 c0 但覆盖的区域不是c，记为x0c。然后使用Pearson线性相关性来衡量xc和xint以及x0c和xint之间基因表达的相似性。如果差异区域与相交区域具有更高的相关性，则认为分割效果更好。

### Sub-cellular analysis

为了在 SCS 细胞分割中进行亚细胞分析，我们将每个细胞掩模分为两个区域：细胞核区域和细胞质区域。使用 Watershed 从染色图像数据中识别细胞核区域，而细胞质区域是通过 SCS 识别的细胞掩模的其余部分。每个区域内所有点检测到的 RNA 被聚合以生成基因表达谱，然后通过基因矩阵在区域中进行汇总。使用矩阵中的 t 检验来识别 RNA 在两组区域之间差异定位的基因。

对于 Stereo-seq 数据集，从每组中鉴定出 P 值 < 0.01 且倍数变化大于 1.3 的基因。然后我们在 RNALocate v2.0 数据库 [9] 中搜索它们以获取 RNA 定位的实验证据。由于使用 Seq-scope 数据集时识别出的基因较少，可能是由于细胞数量较少以及从 H&E 图像中识别细胞核区域所面临的挑战，因此从每组中识别出 P 值最小的前 100 个基因并搜索实验证据。

### Application to stereo-seq

**Stereo-seq 测序部分**：Stereo-seq 数据集在单个切片中捕获整个成年小鼠大脑切片（面积约为 5.3 mm⇥7.0 mm）。条形码斑点排列成网格，斑点之间的距离为 0.5 μm。由于检测尺寸较大，我们将其切成小块进行模型训练，每个小块的面积为 600 μm⇥600 μm（1200 个点⇥1200 个点），总共 87 个块，一次处理一个块。为了获得斑点的稳定基因组成，我们将 3⇥3 个斑点合并为一个斑点。因此，每个合并点聚集了在 1.5 μm⇥1.5 μm 区域中检测到的 RNA。我们使用 Scanpy [10] 计算了斑点上的 2,000 个可变基因，这决定了斑点表达谱中基因的范围。

**立体序列染色**：通过核酸染色对小鼠脑组织切片进行成像，使细胞核区域可视化。染色图像与原始论文中的 RNA 测定进行比对，我们使用线性变换进一步细化比对。

### Application to seq-scope

**Seq-scope 测序切片**：Seq-scope 数据集包含来自小鼠肝脏的四个组织切片。每个切片捕获大约 0.93 mm×0.80 mm 的组织区域。条形码斑点的中心距与 Stereo-seq 数据的距离相似，平均为 0.5 μm。与 Stereo-seq 类似，我们将每个 1.5 μm⇥1.5 μm 区域中的点合并为一个点。我们再次计算了每个部分斑点上的 2,000 个可变基因。

**立体测序染色**：为每个测序部分提供苏木精和曙红 (H&E) 图像。因此，整个细胞体在成像数据中可视化。染色图像已与 Stereo-seq 论文中的 RNA 测定手动对齐。结果，没有进行进一步的改造。我们将 H&E 图像转换为单通道灰度图像以供 Watershed 处理。

## Data

本研究中使用的所有数据之前均已发表。 Stereo-seq 数据集的空间转录组数据和细胞核染色图像可在 MOSTA 数据门户 (https://db.cngb.org/stomics/mosta/download/) 中获取，文件名为 Mouse Brain Adult GEM bin1.tsv。 gz 和小鼠大脑 Adult.tif。 Seq 范围数据集的空间转录组数据可在基因表达综合 (GEO) 数据库中获取，登录号为 GSE169706。本研究中使用了瓷砖 2104、2105、2106 和 2107。 Seqscope 数据集的 H&E 染色图像可在 Deep Blue Data (https://doi.org/10.7302/cjfe-wa35) 上获取。 seqFISH+ NIH/3T3 细胞系数据可在 Zenodo (https://doi.org/10.5281/zenodo.2669683) 上获取。 MERFISH 人脑数据集的空间转录组数据可在 Dryad 上获取 (https://datadryad.org/stash/dataset/doi:10.5061/dryad.x3↵bg7mw)。本研究中使用了 H22.26.401.MTG.4000 的部分。实验性 RNA 亚细胞定位数据可在 RNALocate v2.0 数据库 (https://www.rna-society.org/rnalocate/download.html) 中找到。

## Code

SCS 的源代码可在 https://github.com/chenhcs/SCS 上公开获取。以下开源 Python (3.9.7) 包用于构建 SCS：anndata (0.7.5)、matplotlib (3.5.0)、numpy (1.22.4)、pandas (1.3.4)、scanpy (1.8.2) ）、scikit-learn（1.0.1）、scipy（1.7.2）、tensorflow（2.8.2）。使用开源软件 Spateo (0.0.0) 将染色图像像素与空间转录组学点对齐。在 Spaateo (0.0.0) 中实现的分水岭，开源 Python 包 DeepCell (0.12.3)、Cellpose (2.1.1)、StarDist (0.8.3)、Baysor (0.5.2) 和 JSTA (0.0.0) 分别是应用于分割染色图像并与 SCS 进行比较。

## Figure









![shadow-image-20230810162838962](https://wangleidetuchuang.oss-cn-beijing.aliyuncs.com/img/image-20230810162838962.png)

![shadow-image-20230810162851421](https://wangleidetuchuang.oss-cn-beijing.aliyuncs.com/img/image-20230810162851421.png)

![shadow-image-20230810162906268](https://wangleidetuchuang.oss-cn-beijing.aliyuncs.com/img/image-20230810162906268.png)

![shadow-image-20230810162920222](https://wangleidetuchuang.oss-cn-beijing.aliyuncs.com/img/image-20230810162920222.png)

![shadow-image-20230810162932749](https://wangleidetuchuang.oss-cn-beijing.aliyuncs.com/img/image-20230810162932749.png)