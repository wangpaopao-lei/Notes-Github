1. 重读 SCS，重点在三个 keypoint 的地方，这些需要在完全理解 SCS 的方法后才能知道

   1. 图像嵌入
   2. 模态融合
   3. 损失函数的计算（训练过程）

2. 思考以下方面的方法

   1. 找核，如何基于 Watershed 算法进行优化？如何结合其他信息来实现更精准的找核？比如 RNA velocity、gene localization pathway
   2. 模态融合，如何整合空间信息和基因信息？能否挖掘出更多信息？比如：相邻细胞的相似性
   3. SCS 其实没有真正结合多模态，如何更进一步，形成一套完整的方法？
   4. 其他可能的研究方向？比如：定位细胞器的位置

3. 阅读其他细胞分割方法的论文

   



# SCS 方法重述

## 预处理

对齐

### 找核

==只用到了图象数据==，全部使用 spateo 完成。

1. 构建细胞核掩膜
2. 初始化分水岭标记
3. 运行分水岭
4. 计算每个核的中心（平均坐标）和大小（像素个数）

得到的是一张经过注释的图像，每个细胞核分为一个类别，所处的像素点赋值，非核点为 0

#### 分水岭算法具体步骤

1. **拓扑表示**：首先，可以将图像看作是地形或拓扑地图，其中像素的亮度值代表其高度。
2. **洪水模拟**：在最低点（局部最小值）放水，水会开始上升，随着时间的推移，不同的洼地会被填满水。为了防止水从一个洼地流入另一个洼地，建起“堤坝”（watershed lines）来阻止它们。
3. **最终结果**：当所有的洼地都被填满后，建起的堤坝将形成物体的边界。

### 准备后续数据

==打开测序数据==

寻找高可变基因，后续训练只用到这部分基因

1. 找 xmin 和 ymin，用来调整坐标
2. 为每个 gene 分配 ID，构建双向索引
3. 对每个点的 3×3 邻域，计算其基因表达总数
4. 计算高可变基因（Top2000）



按照一定的采样率获取 spots，准备 nn 的数据。

1. 在分水岭得到的图像中，label 大于 0 的部分：
   1. 在基因表达矩阵中大于 0 的点 -> ==**识别为确定的非背景点，加入 x_train 中**==
2. 在分水岭得到的图像中，label=0 的部分：
   1.  不满足以下两条件的：
      - 与任意细胞核中心距离小于 900（很近很近）
      - 在染色图象中灰度大于 10（染色过度引起的误判）
      - ==**加入到 x_train_bg 中，作为确定的背景点（负样本）,只取和正样本一样的数量**==
   2. 满足任意条件的：在其邻域收集一些点，==作为不确定样本（待预测），加入 x_test 中。==

最终得到的 x 为一个邻居对应基因表达数的表格

y 为其归属的细胞核中心坐标，背景点的 y 为[-1,-1]

同时保存 spot 的坐标位置，==为 x_train_pos==

保存 spot 对应的类别，==为 y_binary==

## transformer 模型

### 预处理

1. 把 y_train 根据对细胞核的相对方向转化为类别，共有 16 个方向，用 one-hot 编码
2. 把 x_train_pos 转化为相对位置（某种程度的 scale 处理）

### 模型实现

1. 同时输入基因表达 X 和 spot 位置 s，各通过一个 fc 输入并投影到 64 维，再相加得到 r
2. r 经过八层 transformer
3. 输出 d-hat 和 y-hat，分别为一个方向类别（后续可以使用 softmax 计算概率）和一个概率（是细胞一部分的概率）

## 后处理

1. 对于y 预测值小于 0.1 的点，判断为背景

### 先验融合

预设一个先验细胞半径，默认为 15

1. 计算所有细胞核到 spot 的距离	
   1. 如果小于先验，将方向加入 class_priori
   2. 如果小于先验 1.25 倍，加入class_priori_ext
2. 如果 class_priori 大于 0，用 ext 替代它
3. 根据 d-hat 的原始输出，通过 softmax，乘以先验向量，得到最终的方向向量

### 梯度向量轨迹追踪算法

1. 对每个非背景点，跟踪其梯度，找到指向的下一个点
2. 如果两个连续步骤间的夹角大于 $\pi/2$，识别为一个 sink，停止追踪（这个地方没看懂为什么是 180°）

### 细胞分割

1. 如果两个 sink 间距离小于 3.5，合并为一个 sink
2. 如果一个 sink 包含超过 200 个点，识别为一个细胞。





## 总结

### 数据生命周期

#### 图像

1. 分水岭得到细胞掩膜
2. 作为 pos 数据表征 spot 间的空间关系（用于梯度求解）

#### 基因表达

1. 协助划分数据集
2. 

# 其他文献

cellpose

1. 人工注释获得掩膜，掩膜图像作为 x
2. 热扩散掩膜图像，得到的向量场作为 y
3. 训练神经网络，神经网络输出位向量场
4. 梯度向量场追踪

# 改进思路

## 针对 Watershed

为什么使用 Watershed？

因为不需要数据去训练，仅仅通过图像本身输出结果



