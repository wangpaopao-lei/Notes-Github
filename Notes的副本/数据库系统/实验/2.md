6.1

```postgresql
CREATE OR REPLACE PROCEDURE bupt2020211538.quanguogesheng_insert("日期" date, "省" character varying, "累计确诊" integer, "累计治愈" integer, "累计死亡" integer)
AS  declare begin
	insert into 全国各省累计数据统计表 values (日期,省,累计确诊,累计治愈,累计死亡);
END;

CALL quanguogesheng_insert('2021-10-8', '吉林省', 578, 571, 3);

SELECT *
FROM 全国各省累计数据统计表
WHERE 日期 = '2021-10-8';
```

![image-20221204164638885](https://wangleidetuchuang.oss-cn-beijing.aliyuncs.com/img/image-20221204164638885.png)

6.2

```postgresql
DROP TABLE 美国某州某日总累计确诊人数和死亡人数;
CREATE TABLE 美国某州某日总累计确诊人数和死亡人数(州 VARCHAR (100),日期 DATE,总累计确诊 INTEGER,总累计死亡 INTEGER);
CREATE OR REPLACE PROCEDURE  sequal_by_state_and_date(in zhou VARCHAR (100),in daytime DATE)
AS
DECLARE
	num1 INTEGER ;
    num2 INTEGER ;
BEGIN 
	SELECT SUM(累计确诊)INTO num1
    FROM 美国各州县确诊与死亡数统计表 
    where 州 =zhou and 日期 =daytime;
  
    SELECT SUM (累计死亡)INTO num2
    FROM 美国各州县确诊与死亡数统计表 
    where 州 =zhou and 日期 =daytime;
	
    INSERT INTO 美国某州某日总累计确诊人数和死亡人数 VALUES(zhou,daytime,num1,num2);
END;

CALL sequal_by_state_and_date('California','2021-1-1');
SELECT * FROM 美国某州某日总累计确诊人数和死亡人数;
```

6.3

```postgresql
DROP TABLE 中美某天累计确诊病例数表;
CREATE TABLE 中美某天累计确诊病例数表(日期 DATE,中累计确诊 INTEGER,美累计确诊 INTEGER);
CREATE OR REPLACE PROCEDURE  sequal_by_date_in_CNnUS(in daytime DATE)
AS
DECLARE
	cnum INTEGER ;
    anum INTEGER ;
BEGIN 
	SELECT SUM(累计确诊)INTO anum
    FROM 美国各州县确诊与死亡数统计表 
    where 日期 =daytime;

    SELECT SUM (累计确诊)INTO cnum
    FROM 全国各省累计数据统计表  
    where 日期 =daytime;
	
    INSERT INTO 中美某天累计确诊病例数表 VALUES(daytime,cnum,anum);
END;

CALL sequal_by_date_in_CNnUS('2021-1-1');
SELECT * FROM 中美某天累计确诊病例数表;
```

6.5

```postgresql
DROP PROCEDURE insert_record_in_US;
CREATE PROCEDURE insert_record_in_US("n日期" date,"n州" CHARACTER VARYING ,"n县" CHARACTER VARYING ,"n累计确诊" INTEGER,"n累计死亡" INTEGER )  
AS 
declare
	countln INTEGER ;
BEGIN 
	SELECT COUNT (*) INTO countln
    FROM 参考信息表  
    WHERE 省州 =n州 AND 市县 =n县;
    
    IF countln=0 THEN 
    	RAISE EXCEPTION  '地点不存在，不允许插入';
    ELSEIF countln>0 THEN 
    	INSERT INTO 美国各州县确诊与死亡数统计表 VALUES (n日期,n州,n县,n累计确诊 ,n累计死亡 );
    END IF ;
END ;

CALL insert_record_in_US('2021-1-1','Georgia','Brantley',123,456);
SELECT * FROM 美国各州县确诊与死亡数统计表 WHERE 州 ='Georgia'AND 县 ='Brantley'AND 日期 ='2021-1-1';
```

6.6

```postgresql
DROP PROCEDURE delete_record_in_bingli;
CREATE PROCEDURE delete_record_in_bingli(d_id INTEGER)
AS 
declare
	count1 INTEGER ;
    count2 INTEGER ;
BEGIN 
	SELECT COUNT (*) INTO count1
    FROM 病例基本信息表 
    where 病例号 =d_id;
    
    SELECT COUNT (*) INTO count2
    FROM 病例行程信息表 
    WHERE 病例号 =d_id;
    
    IF count1>0 THEN 
		DELETE FROM 病例基本信息表
        WHERE 病例号 =d_id;
        RAISE NOTICE '%d已删除',d_id;
        IF count2>0 THEN 
        	DELETE FROM 病例行程信息表 
            WHERE 病例号 =d_id;
            RAISE NOTICE '%d已删除',d_id;
        ELSEIF count2=0 THEN 
        	RAISE NOTICE '病例号%d在行程表中不存在',d_id;
        END IF ;
    ELSEIF count1=0 then
        RAISE NOTICE '病例号%d在基本表中不存在',d_id;
    END IF ;
END ;
 
 
CALL delete_record_in_bingli(1);
SELECT * FROM 病例基本信息表 ORDER BY 病例号  limit 5;
SELECT * FROM 病例行程信息表 ORDER BY 病例号 LIMIT 5;


```

6.7

```postgresql
DROP TABLE 某市风险地区数量表;
CREATE TABLE 某市风险地区数量表(市 VARCHAR (50),中风险地区数 INTEGER ,高风险地区数 INTEGER);

CREATE PROCEDURE search_level( 某市 CHARACTER VARYING )
AS 
declare
	count_zhong INTEGER ;
    count_gao INTEGER ;
BEGIN 
	count_zhong:=0;
	SELECT COUNT (*)INTO count_zhong
    FROM 全国城市疫情风险等级表 
    WHERE 市 =某市 and 风险等级 ='中风险地区';
   	
    count_gao:=0;
	SELECT COUNT (*)INTO count_gao
    FROM 全国城市风险等级表 
    WHERE 市 =某市 and 风险等级 ='高风险地区';
    
    INSERT INTO 某市风险地区数量表 VALUES (某市,count_zhong,count_gao);
END ;
    
    
CALL search_level('北京市');
SELECT * FROM 某市风险地区数量表;
```

