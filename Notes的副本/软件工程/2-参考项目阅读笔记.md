## sanic 框架

![shadow-image-20230329110307439](https://wangleidetuchuang.oss-cn-beijing.aliyuncs.com/img/image-20230329110307439.png)

![shadow-image-20230320192837709](https://wangleidetuchuang.oss-cn-beijing.aliyuncs.com/img/image-20230320192837709.png)

## 文件结构

- chargingInBupt
  - auth.py：用户鉴权模块，实现对用户的授权，以及一个返回用户名的函数（使用 jwt 的方式）
    - <img src="https://wangleidetuchuang.oss-cn-beijing.aliyuncs.com/img/image-20230320200018563.png" alt="shadow-image-20230320200018563" style="zoom: 50%;" />
  - Config.py：读取配置文件
  - Finishchecker.py：实现了结束充电的函数，结合 timer 模块实现按时计费并生成充电详单
  - Json_schema.py：定义了几种json 格式，在 port 中被调用，结合 validate 方法实现对输入数据的处理并转化为可以用于数据库操作的格式
  - Json_validate.py：实现了 validate 函数，用于判断 json 结构是否合法（**目测只能检测出空值**）
  - Orm.py：对象关系映射，数据库里的一张表映射为一个类，使其在代码层面保持统一
  - ==Port.py==：主要业务逻辑的实现，实现后端与数据库的逻辑交互
  - Schedule.py：实现了调度算法函数，排队、等候区、叫号 and so on，在 port 中被调用
  - timer.py：获取当前时间
- Main.py
  1. 调用 timer（timer）：启动时间戳
  2. session commit（orm）：启动数据库
  3. app add_tsak（port）
  4. app run
- ==Api-doc.yml==：组间联调规范说明





## 判断用户是否为管理员

Port.py 中的`user = session.query(User).filter(User.username == username).first()`

用于在 user 数据库中查找 admin 字段



这个字段的设置，与 jwt（令牌）有关，用户的令牌在注册的时候生成，管理员的令牌还没找到

![image-20230427110439125](https://wangleidetuchuang.oss-cn-beijing.aliyuncs.com/img/image-20230427110439125.png)

![image-20230427110830934](https://wangleidetuchuang.oss-cn-beijing.aliyuncs.com/img/image-20230427110830934.png)

1. 用户登录，根据 user 数据库里的 admin 字段结合 username生成jwt 令牌

   <img src="https://wangleidetuchuang.oss-cn-beijing.aliyuncs.com/img/image-20230427113849356.png" alt="image-20230427113849356" style="zoom:50%;" />

   <img src="https://wangleidetuchuang.oss-cn-beijing.aliyuncs.com/img/image-20230427113924256.png" alt="image-20230427113924256" style="zoom:50%;" />

2. 在执行需要身份验证的功能之前，authorized()函数对登录令牌进行验证

==问题==：

在哪里定义的 admin 字段？

*解答*：自己在数据库里添加 admin





![image-20230427114921732](https://wangleidetuchuang.oss-cn-beijing.aliyuncs.com/img/image-20230427114921732.png)

问题：测试环境下，无 token 输入，无法验证功能

*思路*：在请求头里添加 token 内容

