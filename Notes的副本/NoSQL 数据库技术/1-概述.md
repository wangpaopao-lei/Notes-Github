## contents

[toc]

# 概述

![image-20230228095222175](https://wangleidetuchuang.oss-cn-beijing.aliyuncs.com/img/image-20230228095222175.png)

## NOSQL 种类

### 大数据时代 RDB 的问题

1. 扩展困难
2. 读写慢
3. 成本高
4. 有限的支撑容量

## 按数据模型分类

1. 图存储：性能更优、设计与使用更加灵活简单
   - Neo4j
   - Azure Cosmos
   - Virtuoso
2. 文档存储：类似 JSON 的格式存储，可以对某些字段建立索引
   - MongoDB
   - Amazon DynamoDB
   - Databricks
3. key-value 存储：value 的类型丰富多样
   - Redis
   - Amazon DynamoDB
   - Azure Cosmos
4. 列簇存储：方便存储结构化和半结构化数据
   - Cassandra
   - HBASE
   - Azure Cosmos
5. 时序存储
6. 对象存储
7. XML 数据库
8. RDF 存储
9. 搜索引擎

## 特点

1. 不需要预定义模式
2. 无共享架构
3. 弹性可扩展
4. 分区
5. 分发查询到数据
6. 异步复制：基于日志的异步复制
7. BASE

## CAP

C 一致性

A 可用性

P 分区容错性

一个==分布式系统==不能同时满足这三个需求

- CA：关系型数据库

- CP：分布在多个节点上、保证一致性，如 Hbase、MongoDB、Redis

- AP：以最终一致性来确保可用和分区容错，如 Cassandra、CouchDB

## ACID 与 BASE

- Basicly Available：出现不可预知故障时，允许损失部分可用性

- Soft state：允许数据存在中间状态（不同节点的数据副本之间的数据同步允许存在延迟）

- Eventually Consistent：在经过一段时间的同步后，最终能达到一个一致的状态



## 最终一致性技术基础

### Quorum 的 NWR 策略

1. R+W>N：保证数据不会被同时读写

2. W>N/2：保证数据串行化修改

### Paxos 算法

基于消息传递

Proposer（提出提案），Acceptor（表决），Learner

执行一次写操作：

1. 由 leader 发出==prepare== 消息，如果大多数回复==promise==，表示准备好了可以接受写入
2. 第二次发出正式提案==proppse==，如果服务器中大多数回复==Accept==表示成功

**维护一个全局唯一的序列号**，由 propose 流程产生，定义了Accept 应该准备接受带有最新序列号的 propose，**是算法的关键**

### ※ Raft 算法

- leader，接受客户端请求，将日志复制到其他节点
- candidate，用于选举 leader
- follower，负责响应来自 leader 或 candidate 的请求

**思想**

1. 刚开始没有 leader，全是 follower
2. 进行选举，角色转化为 candidate，得票超过半数以上当选为 leader，并设定任期==term==
3. candidate 转化为 follower

#### 三个子问题

1. leader 选举：每个 follower 只能投一票、可以选自己
2. 日志复制：leader从客户端接收日志，向 follower 发出指令
3. 安全性：leader 定期发送心跳检测给 follower，并负责处理更新操作，其他 follower 与其同步提交过的日志

### 向量时钟机制

只告知冲突，不提供解决办法

## 数据复制与分片

复制：将同一份数据拷贝至多个节点

分片：将不同数据存放在不同节点中

数据分片本质上解决的是负载均衡问题，尽可能将数据均匀地分布存储到不同服务器上

- 首选一致性哈希 Consistent Hashing



![image-20230305210214825](https://wangleidetuchuang.oss-cn-beijing.aliyuncs.com/img/image-20230305210214825.png)