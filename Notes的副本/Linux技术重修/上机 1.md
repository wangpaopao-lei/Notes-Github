# Linux 上机作业 1：正则表达式应用



<center>
  王磊 2020211538
</center>





## 实验要求

从因特网上搜索Web页，用wget获取网页，处理网页html文本数据，从中提取出当前时间点北京各监测站的PM2.5浓度，输出如下格式数据。

<img src="https://wangleidetuchuang.oss-cn-beijing.aliyuncs.com/img/image-20231017165439316.png" alt="image-20231017165439316" style="zoom:33%;" />

## 实验过程

### 获取数据

选择`http://www.86pm25.com/city/beijing.html`网页作为数据来源，页面内容如下：

<img src="https://wangleidetuchuang.oss-cn-beijing.aliyuncs.com/img/image-20231017165559552.png" alt="image-20231017165559552" style="zoom:33%;" />

使用 wget 命令将页面保存到本地，使用 ls 命令查看：

```shell
wget http://www.86pm25.com/city/beijing.html
```

![image-20231017103307737](https://wangleidetuchuang.oss-cn-beijing.aliyuncs.com/img/image-20231017103307737.png)

使用 cat 命令查看 html 文件中的内容，分析后注意到，从 <!--站点实时值开始--> 后的这一段内容是我们需要的数据，如下所示

```html
 <!--站点实时值开始-->
                    
<div  style=" margin:auto; width:960px; text-align:center;font-size:14px; font-weight:bold; margin:10px;">各监测站点实时数据</div>
<table >         <thead onclick="sortColumn(event)"><tr style=" background-color:#EBEFF7"><th width="15%"  >监测站点</th><th width="10%" >AQI</th><th width="20%"  >&nbsp;&nbsp;&nbsp;污染等级</th><th width="20%"  >PM2.5浓度</th> <th width="20%"  >PM10浓度</th> </tr></thead>
<tr><td>奥体中心</td><td>50</td><td><img src="../images/wurandengji/you.gif"  /> </td><td>21μg/m³</td><td>50μg/m³</td></tr>
<tr><td>昌平镇</td><td>51</td><td><img src="../images/wurandengji/liang.gif"  /> </td><td>26μg/m³</td><td>51μg/m³</td></tr>
<tr><td>大兴旧宫</td><td>53</td><td><img src="../images/wurandengji/liang.gif"  /> </td><td>34μg/m³</td><td>56μg/m³</td></tr>
<tr><td>定陵</td><td>50</td><td><img src="../images/wurandengji/you.gif"  /> </td><td>26μg/m³</td><td>50μg/m³</td></tr>
<tr><td>东四</td><td>51</td><td><img src="../images/wurandengji/liang.gif"  /> </td><td>22μg/m³</td><td>52μg/m³</td></tr>
<tr><td>房山燕山</td><td>49</td><td><img src="../images/wurandengji/you.gif"  /> </td><td>23μg/m³</td><td>49μg/m³</td></tr>
<tr><td>丰台小屯</td><td>54</td><td><img src="../images/wurandengji/liang.gif"  /> </td><td>26μg/m³</td><td>58μg/m³</td></tr>
<tr><td>丰台云岗</td><td>53</td><td><img src="../images/wurandengji/liang.gif"  /> </td><td>19μg/m³</td><td>56μg/m³</td></tr>
<tr><td>古城</td><td>55</td><td><img src="../images/wurandengji/liang.gif"  /> </td><td>27μg/m³</td><td>59μg/m³</td></tr>
<tr><td>官园</td><td>53</td><td><img src="../images/wurandengji/liang.gif"  /> </td><td>22μg/m³</td><td>55μg/m³</td></tr>
<tr><td>海淀万柳</td><td>55</td><td><img src="../images/wurandengji/liang.gif"  /> </td><td>26μg/m³</td><td>59μg/m³</td></tr>
<tr><td>怀柔新城</td><td>42</td><td><img src="../images/wurandengji/you.gif"  /> </td><td>23μg/m³</td><td>42μg/m³</td></tr>
<tr><td>怀柔镇</td><td>38</td><td><img src="../images/wurandengji/you.gif"  /> </td><td>18μg/m³</td><td>38μg/m³</td></tr>
<tr><td>密云新城</td><td>34</td><td><img src="../images/wurandengji/you.gif"  /> </td><td>14μg/m³</td><td>34μg/m³</td></tr>
<tr><td>密云镇</td><td>45</td><td><img src="../images/wurandengji/you.gif"  /> </td><td>19μg/m³</td><td>45μg/m³</td></tr>
<tr><td>农展馆</td><td>50</td><td><img src="../images/wurandengji/you.gif"  /> </td><td>22μg/m³</td><td>50μg/m³</td></tr>
<tr><td>平谷新城</td><td>45</td><td><img src="../images/wurandengji/you.gif"  /> </td><td>23μg/m³</td><td>45μg/m³</td></tr>
<tr><td>顺义新城</td><td>48</td><td><img src="../images/wurandengji/you.gif"  /> </td><td>19μg/m³</td><td>48μg/m³</td></tr>
<tr><td>天坛</td><td>55</td><td><img src="../images/wurandengji/liang.gif"  /> </td><td>31μg/m³</td><td>60μg/m³</td></tr>
<tr><td>通州东关</td><td>57</td><td><img src="../images/wurandengji/liang.gif"  /> </td><td>30μg/m³</td><td>64μg/m³</td></tr>
<tr><td>万寿西宫</td><td>53</td><td><img src="../images/wurandengji/liang.gif"  /> </td><td>27μg/m³</td><td>56μg/m³</td></tr>
<tr><td>延庆石河营</td><td>54</td><td><img src="../images/wurandengji/liang.gif"  /> </td><td>30μg/m³</td><td>58μg/m³</td></tr>
<tr><td>延庆夏都</td><td>55</td><td><img src="../images/wurandengji/liang.gif"  /> </td><td>26μg/m³</td><td>59μg/m³</td></tr></table>
                    <!--站点实时值结束-->
```



### Grep 筛选数据

分析数据后发现，“更新”后的日期时间数据为我们所需要，“<tr><td>" 标签后的数据为我们所需要，使用 grep 命令筛选出我们需要的信息：

```shell
c538@Ubuntu-bupt:~$ cat beijing.html | grep -e "^<tr><td>" -e '更新'
```



![image-20231017163207708](https://wangleidetuchuang.oss-cn-beijing.aliyuncs.com/img/image-20231017163207708.png)

### Sed 流编辑

使用正则表达式匹配，删除所有标签，将标签替换为空格

```shell
sed -e 's/<[^<>]*>/ /g'
```



![image-20231017163345041](https://wangleidetuchuang.oss-cn-beijing.aliyuncs.com/img/image-20231017163345041.png)

使用正则表达式匹配，格式化时间数据

```shell
sed -e 's/\([0-9][0-9]*\)年\([0-9][0-9]\)月\([0-9][0-9]\)日/\1-\2-\3/g'
```

将“更新”后的：替换为空格，以便后续操作

```shell
-e 's/更新：/更新 /'
```

删除不需要的单位`/μg/m³/`，保留一个单位便于 awk 中区分数据行

```shell
 -e 's/μg\/m³//'
```

得到的结果如图所示

![image-20231017164028690](https://wangleidetuchuang.oss-cn-beijing.aliyuncs.com/img/image-20231017164028690.png)

### awk 文件处理

创建1.awk文件

```shell
vim 1.awk
```

文件内容如下

<img src="https://wangleidetuchuang.oss-cn-beijing.aliyuncs.com/img/image-20231017170748906.png" alt="image-20231017170748906" style="zoom:33%;" />

第一行：读到`更新`这行时，将第二列存为`date`，将第三列存为`time`

第二行：读到含`m`的行时，按格式打印输出字符串

```shell
/更新/ { date=$2;time=$3;}
/m/ {printf("%s %d:00:00,%s,%s\n",date,time,$1,$3);}
```



### 输出

最终得到的命令序列为

```shell
cat beijing.html | grep -e "^<tr><td>" -e '更新' | sed -e 's/<[^<>]*>/ /g' -e 's/更新：/更新 /' -e 's/μg\/m³//' -e 's/\([0-9][0-9]*\)年\([0-9][0-9]\)月\([0-9][0-9]\)日/\1-\2-\3/g' | awk -f 1.awk > 1.csv
```

执行后结果写入`1.csv`文件，结果为

<img src="https://wangleidetuchuang.oss-cn-beijing.aliyuncs.com/img/image-20231017171139518.png" alt="image-20231017171139518" style="zoom: 67%;" />

